<?php
require_once("authorize.php");
require_once("../functions/functions.php");
require_once("../functions/documentBase.php");
require_once("../functions/parsing.php");

$filename = "editDocs.php";
$id = "did";

if (isset($_GET[$id])) {
	$_POST[$id] = $_GET[$id];
 }
/* -------------------------------- if new language chosen ----------------------------- */
if (isset($_GET['langid'])) {
	$_SESSION['langid'] = $_GET['langid'];
	if (isset($_POST[$id])) {
		$params = "?$id=".$_POST[$id];
	}
	header("location:".$filename.$params);
 }

/* --------------------------------- regular translation is submitted ---------------------------------------------------------- */
if (isset($_POST['regularsave'])) {
	$_POST['bodyEditor'] = rmNewlines($_POST['bodyEditor']);
	$_POST['bodyEditor'] = fixQuotes($_POST['bodyEditor']);
	$_POST['bodyEditor'] = saveImages($_POST['bodyEditor']);

	//if translation already exists ------------------------------
	if ($_POST[$id] != "" && mysql_num_rows(mysql_query("SELECT * FROM doc_v WHERE $id=".$_POST[$id]." AND langid=".$_SESSION['langid'])) > 0) {
		$query = "UPDATE doc_v SET ";
		$query .= "$id=".$_POST[$id].", langid=".$_SESSION['langid'].", linktext=\"".$_POST['linktext']."\", pagetitle=\"".$_POST['pagetitle']."\", ";
		$query .= "header=\"".$_POST['header']."\", postheader=\"".$_POST['postheader']."\", description=\"".$_POST['description']."\", body=\"".$_POST['bodyEditor']."\", ";
		$query .= "format=\"".$_POST['format']."\", fid=NULL, link=NULL";
		$query .= " WHERE $id = ".$_POST[$id];
		$query .= " AND langid = ".$_SESSION['langid'];
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if translation does not exits ------------------------------
	} else if ($_POST[$id] != "") { 
		$query = "INSERT INTO doc_v (did, langid, linktext, format, pagetitle, header, postheader, description, body) VALUES ";
		$query .= "( ".$_POST[$id].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['format']."\", \"".$_POST['pagetitle']."\", \"".$_POST['header']."\", \"".$_POST['postheader']."\", \"".$_POST['description']."\", \"".$_POST['bodyEditor']."\" )";
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if document does not exist in any translations -------------- 
	} else {
		if ($_POST['priority'] == "") $_POST['priority'] = 100;
		if ($_POST['ident'] == "") $_POST['ident'] = $_POST['linktext'];
		$query = "INSERT INTO doc (did, typeid, description_img, ident, priority) VALUES ( '', \"".$_POST['typeid']."\", \"".$_POST['description_img']."\", \"".$_POST['ident']."\", \"".$_POST['priority']."\")";
		mysql_query($query);
		$result = mysql_query("SELECT $id FROM doc ORDER BY $id DESC");
		$result = mysql_fetch_row($result);
		$query = "INSERT INTO doc_v (did, langid, linktext, format, pagetitle, header, postheader, description, body) VALUES ";
		$query .= "( ".$result[0].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['format']."\", \"".$_POST['pagetitle']."\", \"".$_POST['header']."\", \"".$_POST['postheader']."\", \"".$_POST['description']."\", \"".$_POST['bodyEditor']."\" )";
		mysql_query($query);
		header("location:$filename?$id=$result[0]");
	}
/* --------------------------------- link translation is submitted ---------------------------------------------------------- */
} else if (isset($_POST['linksave'])) {
	//if translation already exists ------------------------------
	if ($_POST[$id] != "" && mysql_num_rows(mysql_query("SELECT * FROM doc_v WHERE $id=".$_POST[$id]." AND langid=".$_SESSION['langid'])) > 0) {
		$query = "UPDATE doc_v SET ";
		$query .= "$id=".$_POST[$id].", langid=".$_SESSION['langid'].", linktext=\"".$_POST['linktext']."\", pagetitle=NULL, ";
		$query .= "header=NULL, postheader=NULL, description=\"".$_POST['description']."\", body=NULL, format=\"".$_POST['format']."\", fid=NULL, link=\"".$_POST['link']."\"";
		$query .= " WHERE $id = ".$_POST[$id]." AND langid = ".$_SESSION['langid'];
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if translation does not exits ------------------------------
	} else if ($_POST[$id] > 0) { 
		$query = "INSERT INTO doc_v (did, langid, linktext, description, format, link) VALUES ";
		$query .= "( ".$_POST[$id].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['description']."\", \"".$_POST['format']."\", \"".$_POST['link']."\" )";
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if document does not exist in any translations -------------- 
	} else {
		if ($_POST['priority'] == "") $_POST['priority'] = 100;
		if ($_POST['ident'] == "") $_POST['ident'] = $_POST['linktext'];
		$query = "INSERT INTO doc (did, typeid, description_img, ident, priority) VALUES ( '', \"".$_POST['typeid']."\", \"".$_POST['description_img']."\", \"".$_POST['ident']."\", \"".$_POST['priority']."\")";
		mysql_query($query);
		$result = mysql_fetch_row(mysql_query("SELECT $id FROM doc ORDER BY $id DESC"));
		$query = "INSERT INTO doc_v (did, langid, linktext, description, format, link) VALUES ";
		$query .= "( ".$result[0].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['description']."\", \"".$_POST['format']."\", \"".$_POST['link']."\" )";
		mysql_query($query);
		header("location:$filename?$id=$result[0]");
	}
/* --------------------------------- file translation is submitted ---------------------------------------------------------- */
} else if (isset($_POST['filesave'])) {
	//if translation already exists ------------------------------
	if ($_POST[$id] != "" && mysql_num_rows(mysql_query("SELECT * FROM doc_v WHERE $id=".$_POST[$id]." AND langid=".$_SESSION['langid'])) > 0) {
		$query = "UPDATE doc_v SET ";
		$query .= "$id=".$_POST[$id].", langid=".$_SESSION['langid'].", linktext=\"".$_POST['linktext']."\", pagetitle=NULL, ";
		$query .= "header=NULL, postheader=NULL, description=\"".$_POST['description']."\", body=NULL, format=\"".$_POST['format']."\", link=NULL, fid=\"".$_POST['fid']."\"";
		$query .= " WHERE $id = ".$_POST[$id]." AND langid = ".$_SESSION['langid'];
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if translation does not exits ------------------------------
	} else if ($_POST[$id] != "") { 
		$query = "INSERT INTO doc_v (did, langid, linktext, description, format, fid) VALUES ";
		$query .= "( ".$_POST[$id].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['description']."\", \"".$_POST['format']."\", \"".$_POST['fid']."\" )";
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	//if document does not exist in any translations -------------- 
	} else {
		if ($_POST['priority'] == "") $_POST['priority'] = 100;
		if ($_POST['ident'] == "") $_POST['ident'] = $_POST['linktext'];
		$query = "INSERT INTO doc (did, typeid, description_img, ident, priority) VALUES ( '', \"".$_POST['typeid']."\", \"".$_POST['description_img']."\", \"".$_POST['ident']."\", \"".$_POST['priority']."\")";
		mysql_query($query);
		$result = mysql_fetch_row(mysql_query("SELECT $id FROM doc ORDER BY $id DESC"));
		$query = "INSERT INTO doc_v (did, langid, linktext, description, format, fid) VALUES ";
		$query .= "( ".$result[0].", ".$_SESSION['langid'].", \"".$_POST['linktext']."\", \"".$_POST['format']."\", \"".$_POST['description']."\", \"".$_POST['fid']."\" )";
		mysql_query($query);
		header("location:$filename?$id=$result[0]");
	}
/* ------------------------------------ multisave --------------------------------------------- */
 } else if (isset($_POST['multisave'])) {
	//if no we have a valid id
	if ($_POST[$id] != 0) {
		$query = "UPDATE doc SET priority = ".$_POST['priority'].", typeid=".$_POST['typeid'].", description_img=\"".$_POST['description_img']."\", ident=\"".$_POST['ident']."\" WHERE $id='".$_POST[$id]."'";
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	} else if ($_POST[$id] === 0) {
		$query = "UPDATE doc SET priority = ".$_POST['priority'].", ident=\"".$_POST['ident']."\", description_img=\"".$_POST['description_img']."\", WHERE $id='".$_POST[$id]."'";
		mysql_query($query);
		header("location:$filename?$id=".$_POST[$id]);
	} else {		
		header("location:$filename");
	}
 } else if (isset($_POST['delete'])) {
	//if user chose to delete language version:
	if (!isset($_POST[$id]) || $_POST[$id] == "") {
		header("location:$filename");
	}
	if ($_POST[$id] <= 0) {
		//if did == 0, we have index page, and deleting all translations is not allowed
		$numquery = "SELECT langid FROM doc_v WHERE $id=".$_POST[$id];
		$result = mysql_query($numquery);
		if (mysql_num_rows($result) <= 1) {
			echo "<SCRIPT LANGUAGE='javascript'>";
			echo "alert('At least one translation has to exist for this page');";
			echo "document.location = '".$filename."?$id=".$_POST[$id]."';";
			echo "</SCRIPT>";
			exit(0);
		}
	}
	$query = "DELETE FROM doc_v WHERE $id=".$_POST[$id]." AND langid=".$_SESSION['langid'];
	mysql_query($query);
	//check if every language version is deleted .. if so, delete entire id
	$query = "SELECT did FROM doc_v WHERE $id=".$_POST[$id];
	$result = mysql_query($query);
	if (mysql_num_rows($result) <= 0) {
		mysql_query("DELETE FROM doc WHERE $id=".$_POST[$id]);
		mysql_query("DELETE FROM hierarchy WHERE did=".$_POST[$id]);
		mysql_query("DELETE FROM hierarchy WHERE parent=".$_POST[$id]);
		header("location:listDocs.php");
	} else {
		$result = mysql_fetch_row($result);
		$_SESSION['langid'] = $result[0];
		header("location:".$filename."?$id=".$_POST[$id]);
	}
/* -------------- categorization ----------------------------------------------- */
 } else if (isset($_POST['addParent']) && $_POST['addp'] != '-1') {
	mysql_query("INSERT INTO hierarchy (parent, did) VALUES (".$_POST['addp'].", ".$_POST[$id].")");
	header("location:$filename?$id=".$_POST[$id]);
 } else if (isset($_POST['delParent']) && $_POST['delp'] != '-1') {
	mysql_query("DELETE FROM hierarchy WHERE did='".$_POST[$id]."' and parent='".$_POST['delp']."'");
	header("location:$filename?$id=".$_POST[$id]);	

} else if (isset($_POST['addChild']) && $_POST['addc'] != '-1') {
	mysql_query("INSERT INTO hierarchy (parent, did) VALUES (".$_POST[$id].", ".$_POST['addc'].")");
	header("location:$filename?$id=".$_POST[$id]);
 } else if (isset($_POST['delChild']) && $_POST['delc'] != '-1') {
	mysql_query("DELETE FROM hierarchy WHERE did='".$_POST['delc']."' and parent='".$_POST[$id]."'");
	header("location:$filename?$id=".$_POST[$id]);	
/* ----------------- if no form is submitted ------------------------------------ */
 } else	if (isset($_POST[$id])) {
	$query = "SELECT doc.did, doc.description_img, doc.priority, doc.typeid, doc.ident, linktext, pagetitle, header, postheader, description, body, link, fid, format ";
	$query .= "FROM doc, doc_v WHERE doc.did=".$_POST['did']." AND langid=".$_SESSION['langid']." AND doc.did = doc_v.did";
	//echo $query;
	$result = mysql_query($query);
	if (mysql_num_rows($result) > 0) {
		$prop = mysql_fetch_assoc($result);
		$prop['body'] = fixQuotes($prop['body']);
		$prop['body'] = readImages($prop['body']);
	} else {
		$query = "SELECT did, priority, typeid, ident ";
		$query .= "FROM doc WHERE did=".$_POST['did'];
		$result = mysql_query($query);
		$prop = mysql_fetch_assoc($result);
	}
 }
?>
<HTML>
<HEAD>
<script type="text/javascript" src="/CMS/ckeditor/ckeditor.js"></script>
<SCRIPT LANGUAGE='javascript'>
function radiohit(s) {
	var val = getValue(s);
	var f = document.f1;
	if (val == "file" || val == "link") {
		f.pagetitle.disabled = true;
		f.header.disabled = true;
		f.postheader.disabled = true;
		f.regularsave.disabled = true;
	}
	if (val == "file") {
		f.link.disabled = true;
		f.linksave.disabled = true;
		f.fid.disabled = false;
		f.filesave.disabled = false;
	} else if (val == "link") {
		f.link.disabled = false;
		f.linksave.disabled = false;
		f.fid.disabled = true;
		f.filesave.disabled = true;
	} else if (val == "regular") {
		f.fid.disabled = true;
		f.filesave.disabled = true;
		f.link.disabled = true;
		f.linksave.disabled = true;
		f.pagetitle.disabled = false;
		f.header.disabled = false;
		f.postheader.disabled = false;
		f.description.disabled = false;
		f.regularsave.disabled = false;
	}
}

function getValue(s) {
	var radioLength = s.length;
	if(radioLength == undefined)
		if(s.checked)
			return s.value;
		else
			return "";
	for(var i = 0; i < radioLength; i++) {
		if(s[i].checked) {
			return s[i].value;
		}
	}
	return "";
}
</SCRIPT>
<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
	<LINK REL="stylesheet" type="text/css" href="css/general.css">
	<title>Edit/add documents</title>
</HEAD>
	<BODY onLoad="javascript:radiohit(document.f1.format)">
	<TABLE BORDER=0 WIDTH='100%'><TR><TD><H1>Edit/add Documents</H1></TD><TD ALIGN='right'><?php
/* -------------- fix flags ------------------------------------ */
$result = mysql_query("SELECT langid, small FROM lang, images WHERE lang.iid = images.iid ORDER BY priority DESC");
while ($r = mysql_fetch_row($result)) {
	if ($r[0] == $_SESSION['langid']) {
		echo "<IMG SRC='".$publicRoot.$r[1]."' WIDTH='44' HEIGHT='30'>&nbsp;";
	} else {
		echo "<A HREF='$filename?";
		if (isset($_POST[$id])) {
			echo "$id=".$_POST[$id]."&";
		}
		echo "langid=".$r[0]."'><IMG SRC='".$publicRoot.$r[1]."' WIDTH='22' HEIGHT='15' BORDER=0></A>&nbsp;";
	}
 }
/* ------------------------------------------------------------ */
?> 
</TD></TR></TABLE>
<BR><A HREF='listDocs.php'>Back to list of documents</A>
	<HR>

<FORM name="f1" target="_self" method="post" action="<?php echo $filename; ?>" onSubmit="return submitForm();">

<FIELDSET><LEGEND><B>General for all versions</B></LEGEND>
<input type='hidden' name="<?php echo $id; ?>" value="<?php echo $_POST[$id]; ?>">
	<TABLE BORDER=0>
	<TR><TH>type: </TH><TD> <?php echo selectType("typeid", 1, (isset($_POST[$id])) ? $prop['typeid'] : null); ?></TD></TR>
	<TR><TH>identifier: </TH><TD><input TYPE='text' size="95" name="ident" value="<?php echo $prop['ident']; ?>"></TD></TR>
	<TR><TH>description img:</TH><TD><?php echo selectImage("description_img", 0, $prop['description_img']); ?></TD></TR>
	<TR><TH>priority: </TH><TD><input TYPE='text' size="3" name="priority" value="<?php echo $prop['priority']; ?>"></TD></TR>
	</TABLE>
	<INPUT TYPE="submit" value="save" name="multisave">
	</FIELDSET>
	<BR>
	<FIELDSET><LEGEND><B>Translation specific</B></LEGEND>
	<input type='hidden' name='<?php echo $id; ?>' value="<?php echo $_POST[$id]; ?>">
	<B>delete this translation: </B><INPUT TYPE="submit" value="delete" name="delete">
	<HR>
	<TABLE BORDER=0>
	<TR><TH>linktext: </TH><TD><input size="80" name="linktext" value="<?php echo $prop['linktext']; ?>"></TD></TR>
	<TR><TH>description: </TH><TD><TEXTAREA COLS=80 ROWS=3 NAME='description'><?php echo $prop['description'] ?></TEXTAREA></TD></TR>
	<TR><TH>format: </TH><TD>file <INPUT TYPE='radio' NAME='format' VALUE="file" <?php if ($prop['format'] == "file") echo "CHECKED"; ?> onClick="javascript:radiohit(this);">&nbsp; &nbsp;
	link <INPUT TYPE='radio' NAME='format' VALUE="link" <?php if ($prop['format'] == "link") echo "CHECKED"; ?> onClick="javascript:radiohit(this);">&nbsp; &nbsp;
regular <INPUT TYPE='radio' NAME='format' VALUE="regular" <?php if ($prop['format'] == "regular" || !isset($prop['format'])) echo "CHECKED"; ?> onClick="javascript:radiohit(this);"></TD></TR>
	<TR><TH>file: </TH><TD><?php echo selectFile("fid", 1, $prop['fid']); ?><INPUT TYPE="submit" value="savefile" name="filesave"></TD></TR>
	<TR><TH>link: </TH><TD><INPUT TYPE='text' SIZE='80' NAME='link' VALUE="<?php echo $prop['link']; ?>"><INPUT TYPE="submit" value="linksave" name="linksave"></TD></TR>
	<TR><TH>regular: </TH><TD></TD></TR>
	<TR><TH>pagetitle: </TH><TD><input TYPE='text' size="80" name="pagetitle" value="<?php echo $prop['pagetitle'] ?>"></TD></TR>
	<TR><TH>header: </TH><TD><input TYPE='text' size="80" name="header" value="<?php echo $prop['header'] ?>"></TD></TR>
	<TR><TH>postheader: </TH><TD><input TYPE='text' size="80" name="postheader" value="<?php echo $prop['postheader'] ?>"></TD></TR>
	</TABLE>
	<B>body: </B><BR>
<textarea name="bodyEditor"><?php echo $prop['body']; ?></textarea>
<script language="JavaScript" type="text/javascript">
	CKEDITOR.replace( 'bodyEditor' );
	</script>

	<INPUT TYPE="submit" value="save" name="regularsave">
	</FIELDSET>
</form>
	<BR>
	
<?php
	if (isset($_POST[$id])) {
       ?>
	   <FORM target='_self' method='post' action='editDocs.php' name='removeForm'  onSubmit="javascript:return confirm('really commit action?')">
	   <FIELDSET><LEGEND><B>Categorization</B></LEGEND>
	   <input type='hidden' name='<?php echo $id; ?>' value="<?php echo $_POST[$id]; ?>">
	   <?php echo selectDocument("- SELECT PARENT TO ADD -", "addp", 1, null); ?>	<INPUT TYPE="submit" NAME="addParent" VALUE="Set as parent"><BR>
	   <?php echo selectParent(" - SELECT PARENT TO DELETE -", "delp", 1, $_POST[$id]); ?> <INPUT TYPE="submit" NAME="delParent" VALUE="Remove as parent">

	   <?php //if index
		   echo "<HR>";
		   echo selectDocument("- SELECT CHILD TO ADD -", "addc", 1, null);
		   echo "<INPUT TYPE='submit' NAME='addChild' VALUE='Set as child'>";
		   echo "<BR>";
		   echo selectChild("- SELECT CHILD TO REMOVE -", "delc", 1, $_POST[$id]); 
		   echo "<INPUT TYPE='submit' NAME='delChild' VALUE='Remove as child'>";
	   ?>
	   </FIELDSET>
	   </FORM>
	   <?php
	}
?>
<A HREF='listDocs.php'>Back to list of documents</A></BODY>
</HTML>
